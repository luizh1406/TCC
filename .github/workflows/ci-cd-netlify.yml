name: CI + CD Netlify

on:
  push:
    branches:
      - main
      - principal
  pull_request:

jobs:
  ci:
    name: Testes + Build
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Instalar dependÃªncias
        run: npm ci

      - name: Testes backend
        run: npm run test:backend

      - name: Testes frontend
        run: npm run test:frontend

      - name: Build
        run: npm run build
      
      # PASSO DE OTIMIZAÃ‡ÃƒO: Salva a pasta de build para o job de deploy
      - name: ðŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-artifact # Nome do artefato que serÃ¡ baixado no deploy
          path: build/ # Substitua 'build/' se a sua pasta de saÃ­da for diferente
          if-no-files-found: error # Garante que o build gerou arquivos

  sonar:
    name: SonarCloud Analysis
    needs: ci 
    uses: ./.github/workflows/sonarcloud.yml
    
    permissions:
      contents: read
      pull-requests: read
      security-events: write

    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  deploy:
    name: Deploy para Netlify
    needs: [ci, sonar]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/principal')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # NOVO PASSO: Baixa a pasta de build gerada no job 'ci'
      - name: ðŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: site-artifact
          
      # Os passos 'Node', 'Instalar dependÃªncias' e 'Build' foram removidos aqui,
      # pois o artefato baixado jÃ¡ contÃ©m a aplicaÃ§Ã£o pronta para deploy.

      - name: ðŸš€ Deploy na Netlify
        # CORREÃ‡ÃƒO DO ERRO: Usa uma aÃ§Ã£o de terceiros estÃ¡vel para o Netlify CLI
        uses: South-Paw/action-netlify-cli@v2 
        with:
          # CORREÃ‡ÃƒO DO ARGS: Aponta para a pasta do artefato baixado
          args: deploy --dir=site-artifact --prod 
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_TOKEN }} # Usando o secret que vocÃª definiu
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}